{% extends 'base.html' %}

{% block dashboard_title %}
<title>Add New Order - Pencilwood</title>
{% endblock dashboard_title %}

{% block dashboard_body %}
<main>


   <!-- {{order_customer_form}}
   {{order_form}} -->

   <form method="POST" enctype="multipart/form-data" >
      {% csrf_token %}
      <div class="container-fluid">
         <h1 class="mt-4">Add New Order</h1>

         <ol class="breadcrumb mb-4 d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
               <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Dashboard</a></li>
               <li class="breadcrumb-item"><a href="{% url 'order_list' %}">All Order</a></li>
            </div>
            <li class="breadcrumb-item ml-auto">
               <a href="{% url 'add_new_order' %}" class="btn btn-primary" style="margin-left: 10px;">
                  Add Order
               </a>
            </li>
         </ol>

         {% if messages %}
         {% for messages in messages %}
         <ol class="breadcrumb mb-4">
            <div class="alert alert-{{messages.tags}} alert-dismissible fade show" role="alert">
               <strong>Dear {{request.user}}!</strong> {{messages}}
               <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                  <span aria-hidden="true">√ó</span>
               </button>
            </div>
         </ol>
         {% endfor %}
         {% endif %}


         <div class="row">

            <!-- ---------------Person Info Start--------------- -->
            <div class="col-xl-12">
               <div class="card mb-4">
                  <div class="card-header">
                     Personal Info
                  </div>
                  <div class="card-body">
                     <div class="row">
                        <div class="col-md-6">
                           <div class="form-group">
                              <label>{{order_customer_form.company.label}} (Optional)</label>
                              {{order_customer_form.company}}
                           </div>
                        </div>
                        <div class="col-md-6">
                           <div class="form-group">
                              <label>{{order_customer_form.name.label}}</label>
                              {{order_customer_form.name}}
                           </div>
                        </div>
                     </div>
                     <!-- /row-->
                     <div class="row">
                        <div class="col-md-4">
                           <div class="form-group">
                              <label>{{order_customer_form.email.label}}</label>
                              {{order_customer_form.email}}
                           </div>
                        </div>
                        <div class="col-md-4">
                           <div class="form-group">
                              <label>{{order_customer_form.phone_number.label}}</label>
                              {{order_customer_form.phone_number}}
                           </div>
                        </div>
                        <div class="col-md-4">
                           <div class="form-group">
                              <label>{{order_customer_form.second_phone_number.label}} (Optional)</label>
                              {{order_customer_form.second_phone_number}}
                           </div>
                        </div>
                     </div>
                     <!-- /row-->
                     <div class="row">
                        <div class="col-md-6">
                           <div class="form-group">
                              <label>{{order_form.design_file.label}} (Optional)</label>
                              {{order_form.design_file}}
                           </div>
                        </div>
                        <div class="col-md-6">
                           <div class="form-group">
                              <label>{{order_customer_form.source.label}}</label>
                              {{order_customer_form.source}}
                           </div>
                        </div>
                     </div>
                     <!-- /row-->
                     <div class="row">
                        <div class="col-md-6">
                           <div class="form-group">
                              <label>{{order_form.delivery_address.label}}</label>
                              {{order_form.delivery_address}}
                           </div>
                        </div>
                        <div class="col-md-6">
                           <div class="form-group">
                              <label>{{order_form.order_date.label}}</label>
                              {{order_form.order_date}}
                           </div>
                        </div>
                     </div>
                     <!-- /row-->
                     <p>Is it urgent? {{order_form.urgent}}</p>
                  </div>
               </div>
            </div>
            <!-- ---------------Person Info End--------------- -->


            <!-- ---------------Product Info Start--------------- -->
            <style>
               .card-header {
                  background-color: #f8f9fa;
                  font-weight: bold;
               }

               /* --- NEW MOBILE STYLES for a single-line, scrollable table --- */
               @media (max-width: 767.98px) {

                  /* This is the key change: Make the table scroll horizontally */
                  .table-responsive {
                     overflow-x: auto;
                     -webkit-overflow-scrolling: touch;
                     /* Smooth scrolling on iOS */
                  }

                  /* Make table elements smaller and more compact */
                  #selected-products-table th,
                  #selected-products-table td {
                     padding: 0.5rem 0.4rem;
                     /* Reduce padding */
                     font-size: 0.8rem;
                     /* Make font size much smaller */
                     white-space: nowrap;
                     /* Prevent text from wrapping to the next line */
                  }

                  #selected-products-table .form-control {
                     font-size: 0.8rem;
                     padding: 0.2rem 0.4rem;
                     height: auto;
                  }

                  /* Set minimum widths for columns to prevent them from becoming too small */
                  #selected-products-table th:nth-child(1),
                  #selected-products-table td:nth-child(1) {
                     /* ‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü ‡¶®‡¶æ‡¶Æ */
                     min-width: 150px;
                  }

                  #selected-products-table th:nth-child(2),
                  #selected-products-table td:nth-child(2) {
                     /* ‡¶á‡¶â‡¶®‡¶ø‡¶ü ‡¶™‡ßç‡¶∞‡¶æ‡¶á‡¶∏ */
                     min-width: 100px;
                  }

                  #selected-products-table th:nth-child(3),
                  #selected-products-table td:nth-child(3) {
                     /* ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ */
                     min-width: 70px;
                  }

                  #selected-products-table th:nth-child(4),
                  #selected-products-table td:nth-child(4) {
                     /* ‡¶ü‡ßã‡¶ü‡¶æ‡¶≤ ‡¶™‡ßç‡¶∞‡¶æ‡¶á‡¶∏ */
                     min-width: 100px;
                  }

                  /* Footer Styles */
                  #selected-products-table tfoot .form-control {
                     font-size: 0.75rem;
                  }

                  #selected-products-table tfoot input::placeholder {
                     font-size: 0.7rem;
                  }

                  #selected-products-table tfoot td {
                     padding: 0.5rem;
                  }
               }
            </style>
            <!-- <div class="container-fluid my-4"> -->
            <div class="col-xl-12">
               <div class="card mb-4">
                  <div class="card-header">
                     Product info
                  </div>
                  <div class="card-body">
                     <div class="form-group">
                        <label for="product-list">Product List</label>
                        <select id="product-list" class="form-control">
                           <option disabled selected>-- Select Product --</option>
                           {% for product in products %}
                           <option value="{{ product.slug }}" data-name="{{ product.name }}"
                              data-price="{{ product.price }}">
                              {{ product.name }}
                           </option>
                           {% endfor %}
                        </select>
                     </div>

                     <div class="table-responsive mt-4">
                        <table id="selected-products-table" class="table table-bordered text-center">
                           <thead class="thead-light">
                              <tr>
                                 <th>Title</th>
                                 <th>Unit Price</th>
                                 <th>Quantity</th>
                                 <th>Total Price</th>
                                 <th>Action</th>
                              </tr>
                           </thead>
                           <tbody>
                           </tbody>
                           <tfoot>
                              <tr>
                                 <td colspan="3" class="text-right font-weight-bold">Deal Value</td>
                                 <td id="grand-total" class="font-weight-bold text-left">0.00</td>
                                 <td></td>
                              </tr>
                              <tr>
                                 <td colspan="5" class="p-0">
                                    <div class="row no-gutters">
                                       <div class="col-4">
                                          {{ order_form.delivery_charge }}
                                       </div>
                                       <div class="col-4">
                                          {{ order_form.delivery_charge_cost }}
                                       </div>
                                       <div class="col-4">
                                          {{ order_form.advance_amount }}
                                       </div>
                                    </div>
                                 </td>
                              </tr>
                              <tr class="bg-light">
                                 <td colspan="5" class="p-0">
                                    <div class="row no-gutters">
                                       <div class="col-6">
                                          <b class="text-right font-weight-bold">Total Amount</b>
                                          <p id="total-amount" class="font-weight-bold text-left">0.00</p>
                                       </div>
                                       <div class="col-6">
                                          <b class="text-right font-weight-bold">Total Due</b>
                                          <p id="total-due" class="font-weight-bold text-left">0.00</p>
                                       </div>
                                    </div>
                                 </td>
                              </tr>
                           </tfoot>
                        </table>
                     </div>
                  </div>
               </div>
            </div>
            <!-- </div> -->
            <script>
               document.addEventListener('DOMContentLoaded', function () {
                  const productList = document.getElementById('product-list');
                  const tableBody = document.querySelector('#selected-products-table tbody');
                  const grandTotalCell = document.getElementById('grand-total');
                  const totalDueCell = document.getElementById('total-due');
                  const totalAmountCell = document.getElementById('total-amount');
                  const totalRowsCell = document.getElementById('total-rows');
                  const shippingCostInput = document.getElementById('inputDeliveryChargeCost');
                  const advancedPaymentInput = document.getElementById('advanced-payment');
                  const shippingCollectInput = document.getElementById('inputDeliveryCharge');

                  const selectedProducts = {};

                  function updateTotals() {
                     let grandTotal = 0;
                     const rows = tableBody.querySelectorAll('tr');

                     rows.forEach(row => {
                        const totalCell = row.querySelector('.total-price');
                        grandTotal += parseFloat(totalCell.textContent) || 0;
                     });

                     grandTotalCell.textContent = grandTotal.toFixed(2);

                     const shippingCollect = parseFloat(shippingCollectInput.value) || 0;
                     const shippingCost = parseFloat(shippingCostInput.value) || 0;
                     const advancedPayment = parseFloat(advancedPaymentInput.value) || 0;

                     const totalDue = (grandTotal + shippingCollect) - advancedPayment;
                     totalDueCell.textContent = totalDue.toFixed(2);
                     const totalAmount = (grandTotal + shippingCollect) - shippingCost;
                     totalAmountCell.textContent = totalAmount.toFixed(2);

                     totalRowsCell.textContent = rows.length;
                  }

                  productList.addEventListener('change', function () {
                     const selectedOption = this.options[this.selectedIndex];
                     const slug = selectedOption.value;
                     const name = selectedOption.dataset.name;
                     const price = parseFloat(selectedOption.dataset.price);

                     this.selectedIndex = 0;

                     if (selectedProducts[slug]) {
                        alert(`'${name}' already added!`);
                        return;
                     }

                     selectedProducts[slug] = true;

                     const row = document.createElement('tr');
                     row.setAttribute('data-slug', slug);

                     row.innerHTML = `
                        <td>${name}<input type="text" hidden value="${slug}" name="slug"></td>
                        <td><input type="number" class="form-control unit-price-input" value="${price.toFixed(2)}" name="unit_price"></td>
                        <td><input type="number" min="1" value="1" class="form-control quantity-input" name="quantity"></td>
                        <td class="total-price">${price.toFixed(2)}</td>
                        <td><button class="btn btn-danger btn-sm remove-btn">üóëÔ∏è</button></td>
                    `;

                     tableBody.appendChild(row);
                     updateTotals();
                  });

                  tableBody.addEventListener('input', function (e) {
                     const target = e.target;
                     if (target.classList.contains('quantity-input') || target.classList.contains('unit-price-input')) {
                        const row = target.closest('tr');
                        if (!row) return;

                        const quantity = parseFloat(row.querySelector('.quantity-input').value) || 0;
                        const unitPrice = parseFloat(row.querySelector('.unit-price-input').value) || 0;
                        const total = quantity * unitPrice;

                        row.querySelector('.total-price').textContent = total.toFixed(2);
                        updateTotals();
                     }
                  });

                  tableBody.addEventListener('click', function (e) {
                     if (e.target.classList.contains('remove-btn')) {
                        const row = e.target.closest('tr');
                        const slug = row.dataset.slug;
                        delete selectedProducts[slug];
                        row.remove();
                        updateTotals();
                     }
                  });

                  shippingCostInput.addEventListener('input', updateTotals);
                  advancedPaymentInput.addEventListener('input', updateTotals);
                  shippingCollectInput.addEventListener('input', updateTotals);
               });
            </script>
            <!-- ---------------Product Info Start--------------- -->

            <!-- ---------------Status Info Start--------------- -->
            <div class="col-xl-12">
               <div class="card mb-4">
                  <div class="card-header">
                     Status info
                  </div>
                  <div class="card-body">

                     <div class="row">
                        <div class="col-md-4">
                           <div class="form-group">
                              <label>{{order_form.status.label}}</label>
                              {{order_form.status}}
                           </div>
                        </div>
                        <div class="col-md-4">
                           <div class="form-group">
                              <label>{{order_form.work_assign.label}} (Optional)</label>
                              {{order_form.work_assign}}
                           </div>
                        </div>
                        <div class="col-md-4">
                           <div class="form-group">
                              <label>{{order_form.delivery_date.label}} (Optional)</label>
                              {{order_form.delivery_date}}
                           </div>
                        </div>
                     </div>
                     <!-- /row-->
                     <div class="row">
                        <div class="col-md-6">
                           <div class="form-group">
                              <label>{{order_form.remark.label}} (Optional)</label>
                              {{order_form.remark}}
                           </div>
                        </div>
                        <div class="col-md-6">
                           <div class="form-group">
                              <label>{{order_form.special_instructions.label}} (Optional)</label>
                              {{order_form.special_instructions}}
                           </div>
                        </div>
                     </div>
                     <!-- /row-->

                  </div>
               </div>
            </div>
            <!-- ---------------Status Info Start--------------- -->


         </div>
         <div class="text-right mb-4">
            <button type="submit" class="btn btn-success">
               <i class="feather-send"></i> SAVE
            </button>
         </div>
      </div>
   </form>
</main>

<script>
   
</script>


{% endblock dashboard_body %}